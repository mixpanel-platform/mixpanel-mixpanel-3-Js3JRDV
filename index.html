<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <form id="property" style="margin-bottom: 15px; height: 31px">
        <input type="text" autofocus placeholder="List Of Emails" name="property-name-field" value="" style="color: rgb(95,105,131); height: 30px; width: 500px; padding: 0 4px; font-size: 12px; border: 1px solid rgb(201,209,219)">
        <input type="submit" name="submit" value="Run" style="font-weight: bold; color: rgb(95,105,131); font-size: 12px; height: 31px; padding: 0 10px; margin-left: 10px; border: 1px solid rgb(201,209,219); background-color: rgb(242,244,246)">
      </form>
      <div>
        <table id="resultsTable"></table>
      </div>
    <script>
    
    var masterUsers = {};
    var masterProps = {};
    
      MP.api.ready(function() {
        /* pull values out of form */
         $('#property').submit(function(e) {
            $('#lgr-chart').remove();
            e.preventDefault();
            var formData = $('#property input:first').val()
            var listOfEmails = formData.split(' ');
            var i;
            var chartEvent = 'Viewed report';
            var chartData = {};
            
            /* Make API Request for emails */
            var promises = [];
            var params = {
                where: '' 
            }
            var results = [];
            for (i = 0; i < listOfEmails.length; i++){
              
                /* change params to include email */ 
                params.where = '"' + listOfEmails[i] + '"' + ' in properties["$email"]';
                var peopleQuery = MP.api.people(params);
                promises.push(peopleQuery); 
          
            }
            Promise.all(promises).then(function(datums){
                /* Format data */  
                
                _.each(datums, function(datum){
                    results.push(datum.values()['results']);
                });
            }).then(function(){
                runQuery(results);
                setTimeout(graphData(), 10000);
            });
            
        });
        
        var runQuery = function(data) {
          console.log(data);
          var keys = Object.keys(data[0]);
          for(i=0; i<keys.length; i++) {
            var current_user = data[0][i];
            console.log(current_user);
            masterUsers[current_user['$distinct_id']] = {};
            var propkeys = Object.keys(current_user['$properties']);
            for(j=0; j<propkeys.length; j++) {
              masterUsers[current_user['$distinct_id']][propkeys[j]] = current_user['$properties'][propkeys[j]];
              if(masterProps.indexOf(propkeys[j]) < 0) {
                console.log("Adding a key");
                masterProps.push(propkeys[j]);
              }
            }
          }
        }
        
        var graphData = function() {
          console.log(masterProps);
          //write the headers first
          var append_data = '<tr>';
          for(i=0; i<masterProps.length; i++) {
            append_data = append_data + '<td>' + masterProps[i] + '</td>';
          }
          append_data = append_data + '</tr>';
          $('table#resultsTable').append(append_data);
          console.log(append_data);
          
          //now write each user
          var users = Object.keys(masterUsers);
          for(i=0; i<users.length; i++) {
            var append_data = '<tr>';
            for(j=0; j<masterProps.length; j++) {
              if(masterProps[j] in Object.keys(masterUsers[i])) {
                append_data = append_data + + '<td>' + masterUsers[i][masterProps[j]] + '</td>';
              }
              else {
                append_data = append_data + + '<td>' + ' ' + '</td>';
              }
            }
            console.log(append_data);
            $('table#resultsTable').append(append_data);
          }
        }
        
      });
    </script>
  </body>
</html>
